<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://eliasdaler.github.io/favicon.ico><link rel=stylesheet href=/css/style.min.css><link rel=alternate type=application/rss+xml href=https://eliasdaler.github.io/feed.xml title="Elias Daler's blog"><title>How my little C++ meta-serialization library works and how I wrote it</title></head><body><header id=banner><h2><a href=https://eliasdaler.github.io>Elias Daler's blog</a></h2><nav><ul></ul></nav></header><main id=content><article><header id=post-header><h1>How my little C++ meta-serialization library works and how I wrote it</h1><div>Publication date: <time>September 27, 2017</time></div><div></div></header><h2 id=introduction>Introduction</h2><p>A year ago I wrote a small library called <a href=https://github.com/eliasdaler/MetaStuff>MetaStuff</a>. It is used to register meta info about classes, which can be later used for serialization, deserialization, making GUI and so on. The cool thing about it is that you can write a serializer for your own data format, be it JSON, Lua or anything else. The library is very small, it uses C++14, requires no pre-build process, RTTI, macros&mldr; It&rsquo;s just templates!</p><p>Let&rsquo;s look at how registration and serialization work. Suppose you have the following struct:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=font-weight:700>struct</span> <span style=color:#458;font-weight:700>Person</span> {
</span></span><span style=display:flex><span>    <span style=color:#458;font-weight:700>int</span> age;
</span></span><span style=display:flex><span>    std<span style=font-weight:700>::</span>string name;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>You register it like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=font-weight:700>namespace</span> meta {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>template</span> <span style=font-weight:700>&lt;&gt;</span>
</span></span><span style=display:flex><span><span style=font-weight:700>inline</span> <span style=font-weight:700>auto</span> registerMembers<span style=font-weight:700>&lt;</span>Person<span style=font-weight:700>&gt;</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=font-weight:700>return</span> <span style=color:#900;font-weight:700>members</span>(
</span></span><span style=display:flex><span>        member(<span style=color:#b84>&#34;age&#34;</span>, <span style=font-weight:700>&amp;</span>Person<span style=font-weight:700>::</span>age),
</span></span><span style=display:flex><span>        member(<span style=color:#b84>&#34;name&#34;</span>, <span style=font-weight:700>&amp;</span>Person<span style=font-weight:700>::</span>name)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>} <span style=color:#998;font-style:italic>// end of namespace meta
</span></span></span></code></pre></div><p>And now you can serialize / deserialize it to / from JSON! (I&rsquo;ll be using Niels Lohmann&rsquo;s <a href=https://github.com/nlohmann/json>JSON for Modern C++</a> library in this article)</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>Person person;
</span></span><span style=display:flex><span>person.age <span style=font-weight:700>=</span> <span style=color:#099>30</span>;
</span></span><span style=display:flex><span>person.name <span style=font-weight:700>=</span> <span style=color:#b84>&#34;John&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// serialize
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>json j;
</span></span><span style=display:flex><span>j <span style=font-weight:700>=</span> person;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>std<span style=font-weight:700>::</span>cout <span style=font-weight:700>&lt;&lt;</span> std<span style=font-weight:700>::</span>setw(<span style=color:#099>4</span>) <span style=font-weight:700>&lt;&lt;</span> j <span style=font-weight:700>&lt;&lt;</span> std<span style=font-weight:700>::</span>endl;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// deserialize
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>Person p2;
</span></span><span style=display:flex><span>p2 <span style=font-weight:700>=</span> j.get<span style=font-weight:700>&lt;</span>Person<span style=font-weight:700>&gt;</span>(j);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>std<span style=font-weight:700>::</span>cout <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#34;Name = &#34;</span> <span style=font-weight:700>&lt;&lt;</span> p2.name <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#34;, age = &#34;</span> <span style=font-weight:700>&lt;&lt;</span> p2.age <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#34;</span><span style=color:#b84>\n</span><span style=color:#b84>&#34;</span>;
</span></span></code></pre></div><p>Output:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;age&#34;</span>: 30,
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;name&#34;</span>: <span style=color:#b84>&#34;John&#34;</span>
</span></span><span style=display:flex><span><span style=font-weight:700>}</span>
</span></span></code></pre></div><p>Simple as that!</p><p>One more example. In <a href=https://eliasdaler.github.io/re-creation/>my game</a> I have <code>Animation</code> class registered. I also have a bunch of functions for <a href=https://github.com/ocornut/imgui>Dear ImGui</a> which can automatically build GUI for me, so I can easily change animation parameters. I just do this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>ImGui<span style=font-weight:700>::</span>Input(animation);
</span></span></code></pre></div><p>And I get this (the &ldquo;Animation properties&rdquo; table is generated by MetaStuff):</p><figure><img src=animation-editor.gif></figure><h2 id=using-metastuff>Using MetaStuff</h2><p>The most important thing about MetaStuff is that it stores information about class members in a tuple without losing their types. To do something for all members of the class, you write this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>meta<span style=font-weight:700>::</span>doForAllMembers<span style=font-weight:700>&lt;</span>Person<span style=font-weight:700>&gt;</span>(
</span></span><span style=display:flex><span>    [<span style=font-weight:700>&amp;</span>person](<span style=font-weight:700>const</span> <span style=font-weight:700>auto</span><span style=font-weight:700>&amp;</span> member)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// do something for member
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    });
</span></span></code></pre></div><p>The type of <code>member</code> inside the lambda is <code>meta::Member&lt;Person, T></code>, where <code>T</code> is a type of a member you previously registered. This is really nice, because just by calling <code>Member&lt;Person, T>::get(person)</code>, you get a reference to an object from <code>person</code> instance, which you can modify and use in other functions.</p><p>Let&rsquo;s look at a simple example.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>Person person;
</span></span><span style=display:flex><span>person.age <span style=font-weight:700>=</span> <span style=color:#099>30</span>;
</span></span><span style=display:flex><span>person.name <span style=font-weight:700>=</span> <span style=color:#b84>&#34;John&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>meta<span style=font-weight:700>::</span>doForAllMembers<span style=font-weight:700>&lt;</span>Person<span style=font-weight:700>&gt;</span>(
</span></span><span style=display:flex><span>    [<span style=font-weight:700>&amp;</span>person](<span style=font-weight:700>const</span> <span style=font-weight:700>auto</span><span style=font-weight:700>&amp;</span> member)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=font-weight:700>using</span> MemberT <span style=font-weight:700>=</span> meta<span style=font-weight:700>::</span>get_member_type<span style=font-weight:700>&lt;</span><span style=font-weight:700>decltype</span>(member)<span style=font-weight:700>&gt;</span>;
</span></span><span style=display:flex><span>    std<span style=font-weight:700>::</span>cout <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#34;* &#34;</span> <span style=font-weight:700>&lt;&lt;</span> member.getName() <span style=font-weight:700>&lt;&lt;</span>
</span></span><span style=display:flex><span>        <span style=color:#b84>&#34;, value = &#34;</span> <span style=font-weight:700>&lt;&lt;</span> member.get(person) <span style=font-weight:700>&lt;&lt;</span>
</span></span><span style=display:flex><span>        <span style=color:#b84>&#34;, type = &#34;</span> <span style=font-weight:700>&lt;&lt;</span> <span style=font-weight:700>typeid</span>(MemberT).name() <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#39;\n&#39;</span>;
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Output:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>* age, <span style=color:teal>value</span> <span style=font-weight:700>=</span> 30, <span style=color:#999>type</span> <span style=font-weight:700>=</span> int
</span></span><span style=display:flex><span>* name, <span style=color:teal>value</span> <span style=font-weight:700>=</span> John, <span style=color:#999>type</span> <span style=font-weight:700>=</span>
</span></span><span style=display:flex><span>  class std::basic_string&lt;
</span></span><span style=display:flex><span>    char,struct std::char_traits&lt;char&gt;,class std::allocator&lt;char&gt;
</span></span><span style=display:flex><span>  &gt;
</span></span></code></pre></div><hr><p>You can iterate over all members and call template functions or functions with overloads. Suppose you have a function:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=font-weight:700>template</span> <span style=font-weight:700>&lt;</span><span style=font-weight:700>typename</span> T<span style=font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#458;font-weight:700>void</span> print(T obj) {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>print</span>(<span style=color:#458;font-weight:700>int</span> i)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    std<span style=font-weight:700>::</span>cout <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#34;It&#39;s an int! Value = &#34;</span> <span style=font-weight:700>&lt;&lt;</span> i;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>print</span>(<span style=font-weight:700>const</span> std<span style=font-weight:700>::</span>string<span style=font-weight:700>&amp;</span> str)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    std<span style=font-weight:700>::</span>cout <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#34;It&#39;s a string! Value = &#34;</span> <span style=font-weight:700>&lt;&lt;</span> str;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And now we do this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>meta<span style=font-weight:700>::</span>doForAllMembers<span style=font-weight:700>&lt;</span>Person<span style=font-weight:700>&gt;</span>(
</span></span><span style=display:flex><span>    [<span style=font-weight:700>&amp;</span>person](<span style=font-weight:700>const</span> <span style=font-weight:700>auto</span><span style=font-weight:700>&amp;</span> member)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        std<span style=font-weight:700>::</span>cout <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#34;* &#34;</span> <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#34;What is &#34;</span> <span style=font-weight:700>&lt;&lt;</span> member.getName() <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#34; ? &#34;</span>;
</span></span><span style=display:flex><span>        print(member.get(person));
</span></span><span style=display:flex><span>        std<span style=font-weight:700>::</span>cout <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#39;\n&#39;</span>;
</span></span><span style=display:flex><span>    });
</span></span></code></pre></div><p>Output:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>* What is age ? It<span style=color:#b84>&#39;s an int! Value = 30
</span></span></span><span style=display:flex><span><span style=color:#b84>* What is name ? It&#39;</span>s a string! <span style=color:teal>Value</span> <span style=font-weight:700>=</span> John
</span></span></code></pre></div><p><a href=https://github.com/eliasdaler/MetaStuff/blob/master/example/JsonCast.inl#L86>Here</a> you can look at how JSON serialization / deserialization is performed. It&rsquo;s not that complicated: we just need to write some overloads for non-trivial cases (<code>std::vector</code> should be processed as JSON array and <code>std::unordered_map</code> as JSON object). For the main serialization / deserialization loop, we just need to iterate over all registered members and do something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>jsonObject[member.getName()] <span style=font-weight:700>=</span> member.get(person);
</span></span></code></pre></div><p>The serializer can handle much more complex cases, than shown previously, such as instance of one class, being in another class: the serialization will work correctly for registered classes! For example, for the following classes:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=font-weight:700>struct</span> <span style=color:#458;font-weight:700>Health</span> {
</span></span><span style=display:flex><span>    <span style=color:#458;font-weight:700>int</span> hp <span style=font-weight:700>=</span> <span style=color:#099>20</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>struct</span> <span style=color:#458;font-weight:700>Hero</span> {
</span></span><span style=display:flex><span>    Health health;
</span></span><span style=display:flex><span>    <span style=color:#458;font-weight:700>int</span> attackPower <span style=font-weight:700>=</span> <span style=color:#099>30</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>we&rsquo;ll get this JSON:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:navy>&#34;attackPower&#34;</span> : <span style=color:#099>10</span>,
</span></span><span style=display:flex><span>    <span style=color:navy>&#34;health&#34;</span> : {
</span></span><span style=display:flex><span>        <span style=color:navy>&#34;hp&#34;</span> : <span style=color:#099>20</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=nice-things-about-metastuff>Nice things about MetaStuff</h2><ul><li>It doesn&rsquo;t require you to perform some pre-build process to generate additional code.</li><li>It doesn&rsquo;t use RTTI.</li><li>You don&rsquo;t need to modify your class to register meta info about it. This allows you to register classes from code you can&rsquo;t modify, such as libraries.</li><li>It&rsquo;s not constrained to one format or library: you can implement your own serializer / deserializer to any format you want.</li><li>Surprisingly, the code works pretty fast and compilers optimize a lot behind the scenes. My game loads animations using MetaStuff and the performance is pretty close to JSON deserialization written by hand.</li><li>This library can be used for other things other than serialization, such as building GUIs.</li><li>You can use it with getters and setters, instead of raw member pointers.</li></ul><p>Suppose our <code>Person</code> class now looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>Person</span> {
</span></span><span style=display:flex><span><span style=font-weight:700>public</span><span style=font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#458;font-weight:700>void</span> setAge(<span style=color:#458;font-weight:700>int</span> a) { age <span style=font-weight:700>=</span> a; }
</span></span><span style=display:flex><span>    <span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>getAge</span>() <span style=font-weight:700>const</span> { <span style=font-weight:700>return</span> age; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// ... same for name
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=font-weight:700>private</span><span style=font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#458;font-weight:700>int</span> age;
</span></span><span style=display:flex><span>    std<span style=font-weight:700>::</span>string name;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>We pass getter and setter to MetaStuff during registration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>member(<span style=color:#b84>&#34;age&#34;</span>, <span style=font-weight:700>&amp;</span>Person<span style=font-weight:700>::</span>getAge, <span style=font-weight:700>&amp;</span>Person<span style=font-weight:700>::</span>setAge)
</span></span></code></pre></div><p>Now, when we&rsquo;ll serialize object, <code>Person::getAge</code> will get called when getting value of &ldquo;age&rdquo; member.</p><hr><p>You can make more complex serialization process easier by using getters and setters in a non-standard way.
Suppose that you have <code>Sprite</code> class:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>Sprite</span> {
</span></span><span style=display:flex><span><span style=font-weight:700>public</span><span style=font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=font-weight:700>private</span><span style=font-weight:700>:</span>
</span></span><span style=display:flex><span>    Texture texture;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>How do you deserialize it? It&rsquo;s not possible to store <code>Texture</code> in a JSON, so we&rsquo;ll store a texture filename instead:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:navy>&#34;texture&#34;</span> : <span style=color:#b84>&#34;res/images/hero.png&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>But how do we load texture when reading data from JSON? One solution is to register variable, which will store texture&rsquo;s filename, and later call some <code>postInit</code> function:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>meta<span style=font-weight:700>::</span>member(<span style=color:#b84>&#34;texture&#34;</span>, <span style=font-weight:700>&amp;</span>Sprite<span style=font-weight:700>::</span>textureFilename);
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#458;font-weight:700>void</span> Sprite<span style=font-weight:700>::</span>postInit()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    texture.loadFromFile(textureFilename);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>Sprite s;
</span></span><span style=display:flex><span>s <span style=font-weight:700>=</span> j.get<span style=font-weight:700>&lt;</span>Sprite<span style=font-weight:700>&gt;</span>(); <span style=color:#998;font-style:italic>// here we&#39;ll get textureFilename
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>s.postInit(); <span style=color:#998;font-style:italic>// and here our texture we&#39;ll be loaded
</span></span></span></code></pre></div><p>This works, but we can do better! Let&rsquo;s register a <code>loadTexture</code> function as a setter for &ldquo;texture&rdquo;.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>meta<span style=font-weight:700>::</span>member(<span style=color:#b84>&#34;texture&#34;</span>, <span style=font-weight:700>&amp;</span>Sprite<span style=font-weight:700>::</span>getTextureFilename, <span style=font-weight:700>&amp;</span>Sprite<span style=font-weight:700>::</span>loadTexture);
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=font-weight:700>const</span> std<span style=font-weight:700>::</span>string<span style=font-weight:700>&amp;</span> Sprite<span style=font-weight:700>::</span>getTextureFilename() <span style=font-weight:700>const</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=font-weight:700>return</span> textureFilename;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#458;font-weight:700>void</span> Sprite<span style=font-weight:700>::</span>loadTexture(<span style=font-weight:700>const</span> std<span style=font-weight:700>::</span>string<span style=font-weight:700>&amp;</span> filename)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    textureFilename <span style=font-weight:700>=</span> filename;
</span></span><span style=display:flex><span>    texture.loadFromFile(filename);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now, when you&rsquo;ll deserialize from JSON, <code>loadTexture</code> will be called and the texture will get loaded as you want it to. And when you serialize <code>Sprite</code> class to JSON, texture filename gets saved there.</p><p>Now, let&rsquo;s implement simple meta info holder and see how I came from its design to MetaStuff.</p><h2 id=simple-approach-that-kinda-works>Simple approach (that kinda works)</h2><p>It all started from a simple, yet somewhat flawed approach. One easy way to build a meta system is to make it with type-erasure and virtual functions. Full working example can be found <a href=https://gist.github.com/eliasdaler/213d42051958ae21185adbc7edbff915>here</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=font-weight:700>template</span> <span style=font-weight:700>&lt;</span><span style=font-weight:700>typename</span> Class<span style=font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>IMember</span> {
</span></span><span style=display:flex><span><span style=font-weight:700>public</span><span style=font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=font-weight:700>virtual</span> <span style=font-weight:700>~</span>IMember() <span style=font-weight:700>=</span> <span style=font-weight:700>default</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700>virtual</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>fromJson</span>(Class<span style=font-weight:700>&amp;</span> obj, <span style=font-weight:700>const</span> json<span style=font-weight:700>&amp;</span> j) <span style=font-weight:700>const</span> <span style=font-weight:700>=</span> <span style=color:#099>0</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700>virtual</span> json <span style=color:#900;font-weight:700>toJson</span>(<span style=font-weight:700>const</span> Class<span style=font-weight:700>&amp;</span> obj) <span style=font-weight:700>const</span> <span style=font-weight:700>=</span> <span style=color:#099>0</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p><code>IMember</code> is a base class for <code>Member</code> class which will store member info.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=font-weight:700>template</span> <span style=font-weight:700>&lt;</span><span style=font-weight:700>typename</span> Class, <span style=font-weight:700>typename</span> T<span style=font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>Member</span> <span style=font-weight:700>:</span> <span style=font-weight:700>public</span> IMember<span style=font-weight:700>&lt;</span>Class<span style=font-weight:700>&gt;</span> {
</span></span><span style=display:flex><span><span style=font-weight:700>public</span><span style=font-weight:700>:</span>
</span></span><span style=display:flex><span>    Member(T Class<span style=font-weight:700>::*</span> ptr) <span style=font-weight:700>:</span> ptr(ptr) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>fromJson</span>(Class<span style=font-weight:700>&amp;</span> obj, <span style=font-weight:700>const</span> json<span style=font-weight:700>&amp;</span> j) <span style=font-weight:700>const</span> <span style=font-weight:700>override</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        obj.<span style=font-weight:700>*</span>ptr <span style=font-weight:700>=</span> j;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    json <span style=color:#900;font-weight:700>toJson</span>(<span style=font-weight:700>const</span> Class<span style=font-weight:700>&amp;</span> obj) <span style=font-weight:700>const</span> <span style=font-weight:700>override</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=font-weight:700>return</span> json(obj.<span style=font-weight:700>*</span>ptr);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>private</span><span style=font-weight:700>:</span>
</span></span><span style=display:flex><span>    T Class<span style=font-weight:700>::*</span> ptr;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p><code>Member</code> class stores a pointer to a class member which lets us get it directly from <code>Class</code> instance (see how we need to pass it in <code>fromJson</code> / <code>toJson</code> function).</p><p>And now for the class that will store all info about members of a particular class:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=font-weight:700>template</span> <span style=font-weight:700>&lt;</span><span style=font-weight:700>typename</span> Class<span style=font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>ClassMetaInfo</span> {
</span></span><span style=display:flex><span><span style=font-weight:700>public</span><span style=font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=font-weight:700>static</span> <span style=color:#458;font-weight:700>void</span> serialize(Class<span style=font-weight:700>&amp;</span> obj, <span style=font-weight:700>const</span> json<span style=font-weight:700>&amp;</span> j)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=font-weight:700>for</span> (<span style=font-weight:700>const</span> <span style=font-weight:700>auto</span><span style=font-weight:700>&amp;</span> pair : members) {
</span></span><span style=display:flex><span>            <span style=font-weight:700>const</span> <span style=font-weight:700>auto</span><span style=font-weight:700>&amp;</span> memberName <span style=font-weight:700>=</span> pair.first;
</span></span><span style=display:flex><span>            <span style=font-weight:700>const</span> <span style=font-weight:700>auto</span><span style=font-weight:700>&amp;</span> memberPtr <span style=font-weight:700>=</span> pair.second;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            memberPtr<span style=font-weight:700>-&gt;</span>fromJson(obj, j[memberName]);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=font-weight:700>static</span> json <span style=color:#900;font-weight:700>deserialize</span>(<span style=font-weight:700>const</span> Class<span style=font-weight:700>&amp;</span> obj)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        json j;
</span></span><span style=display:flex><span>        <span style=font-weight:700>for</span> (<span style=font-weight:700>const</span> <span style=font-weight:700>auto</span><span style=font-weight:700>&amp;</span> pair : members) {
</span></span><span style=display:flex><span>            <span style=font-weight:700>const</span> <span style=font-weight:700>auto</span><span style=font-weight:700>&amp;</span> memberName <span style=font-weight:700>=</span> pair.first;
</span></span><span style=display:flex><span>            <span style=font-weight:700>const</span> <span style=font-weight:700>auto</span><span style=font-weight:700>&amp;</span> memberPtr <span style=font-weight:700>=</span> pair.second;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            j[memberName] <span style=font-weight:700>=</span> memberPtr<span style=font-weight:700>-&gt;</span>toJson(obj);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=font-weight:700>return</span> j;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=font-weight:700>template</span> <span style=font-weight:700>&lt;</span><span style=font-weight:700>typename</span> T<span style=font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=font-weight:700>static</span> <span style=color:#458;font-weight:700>void</span> registerMember(<span style=font-weight:700>const</span> <span style=color:#458;font-weight:700>char</span><span style=font-weight:700>*</span> name, T Class<span style=font-weight:700>::*</span> ptr)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        members.emplace(name, std<span style=font-weight:700>::</span>make_unique<span style=font-weight:700>&lt;</span>Member<span style=font-weight:700>&lt;</span>Class, T<span style=font-weight:700>&gt;&gt;</span>(ptr));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=font-weight:700>using</span> MemberPtrType <span style=font-weight:700>=</span> std<span style=font-weight:700>::</span>unique_ptr<span style=font-weight:700>&lt;</span>IMember<span style=font-weight:700>&lt;</span>Class<span style=font-weight:700>&gt;&gt;</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700>using</span> MemberMapType <span style=font-weight:700>=</span> std<span style=font-weight:700>::</span>unordered_map<span style=font-weight:700>&lt;</span>std<span style=font-weight:700>::</span>string, MemberPtrType<span style=font-weight:700>&gt;</span>;
</span></span><span style=display:flex><span><span style=font-weight:700>private</span><span style=font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=font-weight:700>static</span> MemberMapType members;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>template</span> <span style=font-weight:700>&lt;</span><span style=font-weight:700>typename</span> Class<span style=font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=font-weight:700>typename</span> ClassMetaInfo<span style=font-weight:700>&lt;</span>Class<span style=font-weight:700>&gt;::</span>MemberMapType ClassMetaInfo<span style=font-weight:700>&lt;</span>Class<span style=font-weight:700>&gt;::</span>members;
</span></span></code></pre></div><p><code>ClassMetaInfo</code> class stores all members in members <code>unordered_map</code>. We can&rsquo;t store objects of different classes inside <code>unordered_map</code>, because <code>Member&lt;Class, int></code> and <code>Member&lt;Class, std::string></code> have different types. That&rsquo;s why they have the common base class and virtual functions which will help us get the original type back (at least for a function call).</p><p>Let&rsquo;s use it:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=font-weight:700>struct</span> <span style=color:#458;font-weight:700>Person</span> {
</span></span><span style=display:flex><span>    std<span style=font-weight:700>::</span>string name;
</span></span><span style=display:flex><span>    <span style=color:#458;font-weight:700>int</span> age;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=font-weight:700>static</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>registerClass</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        ClassMetaInfo<span style=font-weight:700>&lt;</span>Person<span style=font-weight:700>&gt;::</span>registerMember(<span style=color:#b84>&#34;name&#34;</span>, <span style=font-weight:700>&amp;</span>Person<span style=font-weight:700>::</span>name);
</span></span><span style=display:flex><span>        ClassMetaInfo<span style=font-weight:700>&lt;</span>Person<span style=font-weight:700>&gt;::</span>registerMember(<span style=color:#b84>&#34;age&#34;</span>, <span style=font-weight:700>&amp;</span>Person<span style=font-weight:700>::</span>age);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>main</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Person<span style=font-weight:700>::</span>registerClass();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Person p{ <span style=color:#b84>&#34;John&#34;</span>, <span style=color:#099>30</span> };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    json j <span style=font-weight:700>=</span> ClassMetaInfo<span style=font-weight:700>&lt;</span>Person<span style=font-weight:700>&gt;::</span>deserialize(p);
</span></span><span style=display:flex><span>    std<span style=font-weight:700>::</span>cout <span style=font-weight:700>&lt;&lt;</span> std<span style=font-weight:700>::</span>setw(<span style=color:#099>4</span>) <span style=font-weight:700>&lt;&lt;</span> j <span style=font-weight:700>&lt;&lt;</span> std<span style=font-weight:700>::</span>endl;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Person p2;
</span></span><span style=display:flex><span>    ClassMetaInfo<span style=font-weight:700>&lt;</span>Person<span style=font-weight:700>&gt;::</span>serialize(p2, j);
</span></span><span style=display:flex><span>    std<span style=font-weight:700>::</span>cout <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#34;Name = &#34;</span> <span style=font-weight:700>&lt;&lt;</span> p2.name <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#34;, age = &#34;</span> <span style=font-weight:700>&lt;&lt;</span> p2.age <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#34;</span><span style=color:#b84>\n</span><span style=color:#b84>&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Output:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;age&#34;</span>: 30,
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;name&#34;</span>: <span style=color:#b84>&#34;John&#34;</span>
</span></span><span style=display:flex><span><span style=font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:teal>Name</span> <span style=font-weight:700>=</span> John, <span style=color:teal>age</span> <span style=font-weight:700>=</span> <span style=color:#099>30</span>
</span></span></code></pre></div><p>Okay, that worked!
This system worked well for me, until I understood that if I wanted to add another format (for example, XML), I&rsquo;d have to add new <code>toXml</code> / <code>fromXml</code> virtual functions everywhere. Same for ImGui and anything else. The other problem was the need to call <code>registerClass</code> function. If I forgot to do it, the &ldquo;members&rdquo; map will be empty for the corresponding class. It&rsquo;s also very hard to implement serializer which will handle nested classes, as shown with <code>Hero</code> / <code>Health</code> example shown previously.</p><h2 id=implementation-of-metastuff>Implementation of MetaStuff</h2><p>Let&rsquo;s see what had to be changed from a previous meta-library to get this functionality.</p><p>First of all, instead of storing members in an <code>unordered_map</code>, I store them in a <code>tuple</code>. It looks like this for a <code>Person</code> class:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=font-weight:700>::</span>tuple<span style=font-weight:700>&lt;</span>Member<span style=font-weight:700>&lt;</span>Person, std<span style=font-weight:700>::</span>string<span style=font-weight:700>&gt;</span>, Member<span style=font-weight:700>&lt;</span>Person, <span style=color:#458;font-weight:700>int</span><span style=font-weight:700>&gt;&gt;</span> members;
</span></span></code></pre></div><p>With some template magic and Vittorio Romero&rsquo;s help (see <a href="https://www.youtube.com/watch?v=Za92Tz_g0zQ">this awesome video</a>), I implemented a function which calls some lambda for each member of the tuple. And that&rsquo;s what <code>meta::doForAllMembers</code> does: it iterates over all Member objects inside of members tuple and calls lambda passed as the function parameter for each of them. The lambda which is used is a <a href=https://isocpp.org/wiki/faq/cpp14-language#generic-lambdas>generic one</a>, so on each call you get a <code>Member&lt;Class, T></code> object without type erasure!</p><p>Let&rsquo;s look at class registration. To register <code>Person</code> class, you have to write this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=font-weight:700>namespace</span> meta {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>template</span> <span style=font-weight:700>&lt;&gt;</span>
</span></span><span style=display:flex><span><span style=font-weight:700>inline</span> <span style=font-weight:700>auto</span> registerMembers<span style=font-weight:700>&lt;</span>Person<span style=font-weight:700>&gt;</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=font-weight:700>return</span> <span style=color:#900;font-weight:700>members</span>(
</span></span><span style=display:flex><span>        member(<span style=color:#b84>&#34;age&#34;</span>, <span style=font-weight:700>&amp;</span>Person<span style=font-weight:700>::</span>age),
</span></span><span style=display:flex><span>        member(<span style=color:#b84>&#34;name&#34;</span>, <span style=font-weight:700>&amp;</span>Person<span style=font-weight:700>::</span>name)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>} <span style=color:#998;font-style:italic>// end of namespace meta
</span></span></span></code></pre></div><p>Note the <code>auto</code> as the return type. You don&rsquo;t want to write <code>std::tuple&lt;Member&lt;Person, std::string>, Member&lt;Person, int>></code>, the compiler can just deduce it! Imagine the class with 50 members. The return type would be gigantic and the compiler does all the work for you.</p><p>Okay, how do we make sure that this <code>registerMembers&lt;T></code> function gets called? Simple! I just made class called <a href=https://github.com/eliasdaler/MetaStuff/blob/master/include/detail/MetaHolder.h>MetaHolder</a>, which uses one nice trick. Let&rsquo;s look at the implementation:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#999;font-weight:700>#pragma once
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700></span>
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700>#include</span> <span style=color:#999;font-weight:700>&lt;tuple&gt;</span><span style=color:#999;font-weight:700>
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700></span>
</span></span><span style=display:flex><span><span style=font-weight:700>namespace</span> meta
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=font-weight:700>namespace</span> detail
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>template</span> <span style=font-weight:700>&lt;</span><span style=font-weight:700>typename</span> T, <span style=font-weight:700>typename</span> TupleType<span style=font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=font-weight:700>struct</span> <span style=color:#458;font-weight:700>MetaHolder</span> {
</span></span><span style=display:flex><span>    <span style=font-weight:700>static</span> TupleType members;
</span></span><span style=display:flex><span>    <span style=font-weight:700>static</span> <span style=font-weight:700>const</span> <span style=color:#458;font-weight:700>char</span><span style=font-weight:700>*</span> <span style=color:#900;font-weight:700>name</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=font-weight:700>return</span> registerName<span style=font-weight:700>&lt;</span>T<span style=font-weight:700>&gt;</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>template</span> <span style=font-weight:700>&lt;</span><span style=font-weight:700>typename</span> T, <span style=font-weight:700>typename</span> TupleType<span style=font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>TupleType MetaHolder<span style=font-weight:700>&lt;</span>T, TupleType<span style=font-weight:700>&gt;::</span>members <span style=font-weight:700>=</span> registerMembers<span style=font-weight:700>&lt;</span>T<span style=font-weight:700>&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>} <span style=color:#998;font-style:italic>// end of namespace detail
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>} <span style=color:#998;font-style:italic>// end of namespace meta
</span></span></span></code></pre></div><p>How do we force the instantiation of this template to get generated? Simple, we just use some function from namespace <code>meta</code>! For example, if you call <code>meta::doForAllMembers&lt;Person></code>, it will use <code>MetaHolder&lt;Person, TupleType></code> class, which will get compiler to generate this class! Its tuple is initialized by calling <code>meta::registerMembers&lt;Person></code>, when the initialization of <code>members</code> tuple is performed. But wait, how do I get <code>TupleType</code>? I get it from <code>registerMember&lt;T></code> function! So, <code>TupleType = decltype(registerMembers&lt;T>())</code>.</p><p>So, we get a function like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=font-weight:700>template</span> <span style=font-weight:700>&lt;</span><span style=font-weight:700>typename</span> Class<span style=font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=font-weight:700>const</span> <span style=font-weight:700>auto</span><span style=font-weight:700>&amp;</span> getMembers()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=font-weight:700>return</span> detail<span style=font-weight:700>::</span>MetaHolder<span style=font-weight:700>&lt;</span>Class, <span style=font-weight:700>decltype</span>(registerMembers<span style=font-weight:700>&lt;</span>Class<span style=font-weight:700>&gt;</span>())<span style=font-weight:700>&gt;::</span>members;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=doing-something-for-one-member>Doing something for one member</h3><p>Suppose we want to do some things only for member called &ldquo;name&rdquo; using MetaStuff:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>meta<span style=font-weight:700>::</span>doForAllMembers<span style=font-weight:700>&lt;</span>Person<span style=font-weight:700>&gt;</span>(
</span></span><span style=display:flex><span>    [<span style=font-weight:700>&amp;</span>person](<span style=font-weight:700>const</span> <span style=font-weight:700>auto</span><span style=font-weight:700>&amp;</span> member)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=font-weight:700>if</span> (member.getName() <span style=font-weight:700>==</span> <span style=color:#b84>&#34;name&#34;</span>) {
</span></span><span style=display:flex><span>            std<span style=font-weight:700>::</span>cout <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#34;Name starts with &#34;</span> <span style=font-weight:700>&lt;&lt;</span> member.get(person)[<span style=color:#099>0</span>] <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#39;\n&#39;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    });
</span></span></code></pre></div><p>Sadly, this doesn&rsquo;t work! Why? Because lambda gets generated for all registered types! Not just for strings, but for <code>Person::age</code>, which is an <code>int</code>. The code <code>member.get(person)[0]</code> is not valid for <code>Member</code> whose type is <code>int</code>, so the compilation fails.</p><p>We can use special <code>doForMember</code> function, which will work well:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>meta<span style=font-weight:700>::</span>doForMember<span style=font-weight:700>&lt;</span>Person, std<span style=font-weight:700>::</span>string<span style=font-weight:700>&gt;</span>(<span style=color:#b84>&#34;name&#34;</span>,
</span></span><span style=display:flex><span>    [<span style=font-weight:700>&amp;</span>person](<span style=font-weight:700>const</span> <span style=font-weight:700>auto</span><span style=font-weight:700>&amp;</span> member)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        std<span style=font-weight:700>::</span>cout <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#34;Name starts with &#34;</span> <span style=font-weight:700>&lt;&lt;</span> member.get(person)[<span style=color:#099>0</span>] <span style=font-weight:700>&lt;&lt;</span> <span style=color:#b84>&#39;\n&#39;</span>;
</span></span><span style=display:flex><span>    });
</span></span></code></pre></div><p>How does it work? With some SFINAE:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=font-weight:700>template</span> <span style=font-weight:700>&lt;</span><span style=color:#458;font-weight:700>bool</span> Test,
</span></span><span style=display:flex><span>    <span style=font-weight:700>typename</span> F, <span style=font-weight:700>typename</span>... Args,
</span></span><span style=display:flex><span>    <span style=font-weight:700>typename</span> <span style=font-weight:700>=</span> std<span style=font-weight:700>::</span>enable_if_t<span style=font-weight:700>&lt;</span>Test<span style=font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#458;font-weight:700>void</span> call_if(F<span style=font-weight:700>&amp;&amp;</span> f, Args<span style=font-weight:700>&amp;&amp;</span>... args)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    f(std<span style=font-weight:700>::</span>forward<span style=font-weight:700>&lt;</span>Args<span style=font-weight:700>&gt;</span>(args)...);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>template</span> <span style=font-weight:700>&lt;</span><span style=color:#458;font-weight:700>bool</span> Test,
</span></span><span style=display:flex><span>    <span style=font-weight:700>typename</span> F, <span style=font-weight:700>typename</span>... Args,
</span></span><span style=display:flex><span>    <span style=font-weight:700>typename</span>, <span style=font-weight:700>typename</span> <span style=font-weight:700>=</span> <span style=color:#458;font-weight:700>void</span><span style=font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#458;font-weight:700>void</span> call_if(F<span style=font-weight:700>&amp;&amp;</span> <span style=color:#998;font-style:italic>/* f */</span>, Args<span style=font-weight:700>&amp;&amp;</span>... <span style=color:#998;font-style:italic>/* args */</span>)
</span></span><span style=display:flex><span>{ <span style=color:#998;font-style:italic>/* do nothing */</span> }
</span></span></code></pre></div><p>And then I do this in <code>doForMember</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>detail<span style=font-weight:700>::</span>call_if<span style=font-weight:700>&lt;</span>std<span style=font-weight:700>::</span>is_same<span style=font-weight:700>&lt;</span>MemberT, T<span style=font-weight:700>&gt;::</span>value<span style=font-weight:700>&gt;</span>(std<span style=font-weight:700>::</span>forward<span style=font-weight:700>&lt;</span>F<span style=font-weight:700>&gt;</span>(f), member);
</span></span></code></pre></div><p>If <code>std::is_same</code> returns <code>true</code>, then <code>call_if</code> with function call gets generated, otherwise <code>call_if</code> function will be empty. Remember that &ldquo;f&rdquo; is most likely to be generic lambda, so if it doesn&rsquo;t get called with some argument, then template instantiation for this type is not generated and everything works as expected.</p><h2 id=conclusion>Conclusion</h2><p>And that&rsquo;s mostly how MetaStuff works! The library is a bit more complicated than that, because it lets you register classes without default constructors, register getters and setters and more.</p><p>The library is still very simple and needs much more work on it. But it&rsquo;s certainly one of the hardest things I&rsquo;ve ever written and I&rsquo;m very proud of it. I&rsquo;ve learned a lot about templates, and I hope you did too. Maybe this article even will inspire you to write your own library or start using MetaStuff for you projects.</p><p>Thank you for reading!</p></article></main><footer id=footer> 2022 Elias Daler. All rights reserved.<p>subscribe via <a href=https://eliasdaler.github.io/feed.xml>RSS</a></p></footer></body></html>